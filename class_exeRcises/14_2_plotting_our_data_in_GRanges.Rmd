---
title: "our_data_in_ranges"
author: "JR"
date: "11/3/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GenomicRanges)
source("../util/intersect_functions.R")
source("../util/plotting_functions.R")
source("../util/_setup.R")
library(Gviz)
library(ggplot2)
```


Alright time to start digging into the data for new results !!
We have made a consensus peak file for each DBP and 
Moreover, we have a data frame of a bunch of peak overlap features for each DBP.

First let's load in the consensu peak files (this is something we always have to do)
```{r}

fl <- list.files("../data/consensus_peaks", full.names=TRUE)
consensus_peaks <- lapply(fl, rtracklayer::import, format = "bed")


# Let's take a look since this is an important first step.
# Ok we should probably add some names -- another common task.
# we can get name from @elementdata$listdata$name

consensus_peaks[[40]]$name %>%
  head()

# cool now we can strsplit this to get the name on the left of _

names(consensus_peaks) <- sapply(consensus_peaks, function(x){
  unlist(strsplit(x$name, "_"))[[1]]
  
})

# Now we have a named list of consensus peaks in the environment -- let's take a look
```


Let's load in our num_peaks_df and decide if we want to filter?
```{r}

# loading in our previous analyses:

num_peaks_df <- read.csv("/Shares/rinn_class/data/CLASS_2022/class_exeRcises/analysis/13_ChIP_peak_features/num_peaks_df.csv")
  
# if we want to filter to those DBPs with at least 500 peaks:

num_peaks_threshold <- 500
dbps_with_sufficient_peaks <- num_peaks_df$num_peaks > num_peaks_threshold

# let's see how many we loose doing this:
summary(dbps_with_sufficient_peaks)

# Note that the enviroment var is still 483 long as it is boolean.
# Let's filter our consensus peaks GRanges list

filtered_consensus_peaks <- consensus_peaks[sapply(consensus_peaks, length) > num_peaks_threshold]

# Could also filter like this:

filtered_consensus_peaks <- consensus_peaks[dbps_with_sufficient_peaks]

# we can record the result of what percentile this cutoff is at :
threshold_percentile <- round(ecdf(num_peaks_df$num_peaks)(num_peaks_threshold)*100,1)

```

Ok enough set up let's dig in with making some plots!

```{r}

# First let's look at a histogram of peak#/DBP

 ggplot(num_peaks_df, aes(x = num_peaks)) + 
  geom_histogram(bins = 70)

# We can add a bunch of example geom_() functions

ggplot(num_peaks_df, aes(x = num_peaks)) + 
  geom_histogram(bins = 70) +

  geom_vline(xintercept = num_peaks_threshold, lty = 2,
             size = 1.1, color = "#a8404c") +
  annotate(geom = "text", x = num_peaks_threshold + 3e3, y = 35, 
           color = "#a8404c", label = paste0("t=", num_peaks_threshold)) +
    annotate(geom = "text", x = num_peaks_threshold + 2.2e3, y = 32, 
           color = "#a8404c", label = paste0(round(threshold_percentile,0), "%")) +
  xlab("Number of consensus peaks") +
  ylab("Count") +
  ggtitle("Distribution of number of consensus peaks")
  
# Now let's save this figure as a result using ggsave.
# ** important to make 'figures' dir in analysis 14_2
  

ggsave("/Shares/rinn_class/data/CLASS_2022/class_exeRcises/analysis/14_2_plotting_our_data/figures/consensus_peaks_histogram.pdf")

# we will save figures in: /analysis/X_RMD/figures so we have a dir
# for each RMD output that has figures corresponding to that code.
```




```{r}

# Let's plot our result of num_peaks versus genome coverage.

ggplot(num_peaks_df, aes(x = num_peaks, y = total_peak_length, label = dbp)) +
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE, color = "black", lty = 2,
              formula = 'y ~ x') +
  geom_text() +
  ylab("BP covered") +
  xlab("Number of peaks") +
  ggtitle("Peak count vs. total bases covered")

ggsave("/Shares/rinn_class/data/CLASS_2022/class_exeRcises/analysis/14_2_plotting_our_data/figures/peak_num_vs_coverage.pdf")

# Feel free to copy code from 14_plotting_R_part_I.Rmd for other versions of this figure.

```


Let's did in a bit deeper and see how coverage on promoters.
```{r}
# now let's plot x as num_peaks and y num overlapping promoters.

ggplot(num_peaks_df,
       aes(x = num_peaks, y = peaks_overlapping_promoters)) +
  

  xlab("Peaks per DBP") +
  ylab("Number of peaks overlapping promoters") +
  ggtitle("Relationship Between Number of DBP Peaks and Promoter Overlaps")+
  geom_point() +
  geom_abline(slope = 1, linetype="dashed") +
  geom_smooth(method = "lm", se=F, formula = 'y ~ x',
              color = "#a8404c") +
  stat_regline_equation(label.x = 35000, label.y = 18000) +
  ylim(0,60100) +
  xlim(0,60100)

ggsave("/Shares/rinn_class/data/CLASS_2022/class_exeRcises/analysis/14_2_plotting_our_data/figures/3_peak_num_vs_promoter_coverage.pdf")
```


Coverage on gene bodies
```{r}


ggplot(num_peaks_df,
       aes(x = num_peaks, y = peaks_overlapping_genebody)) +
  

  xlab("Peaks per DBP") +
  ylab("Number of peaks overlapping genes") +
  ggtitle("Relationship Between Number of DBP Peaks and Gene Body Overlaps")+
  geom_point() +
  geom_abline(slope = 1, linetype="dashed") +
  geom_smooth(method = "lm", se=F, formula = 'y ~ x',
              color = "#a8404c") +
  stat_regline_equation(label.x = 35000, label.y = 18000) +
  ylim(0,60100) +
  xlim(0,60100)

# Interesting result !! Gene bodies explain amost all the places of binding in 
# the genome! Where as promoters had a non linear asymptope after a certain number 
# of peaks. VERY COOL and surprising. There are billions of other possible binding sites!

ggsave("/Shares/rinn_class/data/CLASS_2022/class_exeRcises/analysis/14_2_plotting_our_data/figures/4_peak_num_vs_gene_body_coverage.pdf")
```

Ok so we have started generating results in this handy num_peaks_df. 
However, the peak_occurence_df is also very handy for analyses.
Let's load it in and do some analyses -- THIS ONE IS REALLY COOL :).

```{r}

# First read the file into an object

peak_occurence_df <- read.csv("/Shares/rinn_class/data/CLASS_2022/class_exeRcises/analysis/13_ChIP_peak_features/peak_occurence_dataframe.csv")

# let's have a look. This is a summary of the peak occurence df.
# we did colsums to find how many binding events there are at each promoter
# so the last column will tell us how many binding events there were at a given promoter. 

```


Let's make a density plot of num DBPs bound per promoter
```{r}

# Since we are making a density plot we only need the X axis.

ggplot(peak_occurence_df, aes(x = number_of_dbp)) +
geom_density(alpha = 0.2, color = "#424242", fill = "#424242") +
  
  theme_paperwhite() +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events",
          subtitle = "mRNA and lncRNA genes") 

# Wow what a result! Last year we only saw up to 111 binding events at a promoter
# this is kind of validated where the first peak in the distribution falls at 100
# binding events -- yet there is a second distribution of regions of 300 or more 
# binding events -- wonder what those are :) ?

# VERY COOL let's print out the figure

ggsave("/Shares/rinn_class/data/CLASS_2022/class_exeRcises/analysis/14_2_plotting_our_data/figures/5_num_binding_events_per_promoter.pdf")

```


Lets find how many promoters don't have any DBPs bound

```{r}

unbound_promoters <- peak_occurence_df %>% filter(peak_occurence_df$number_of_dbp < 1)
nrow(unbound_promoters)

# here is just a simple index and filter of the index to have at least 1 dbp bound.
#  let's put it in a folder called results. We will always use this folder structure

write_csv(unbound_promoters, "/Shares/rinn_class/data/CLASS_2022/class_exeRcises/analysis/14_2_plotting_our_data/results/unbound_promoters.csv")
```


Do any DBPs never bind a promoter?
```{r}

# we actually don't need code for this we can look in num_peaks_df and sort :)

# There are only a few and we may want to filter these out above.
```

Let's compare the binding patterns of lncRNA vs mRNA promoters.
While we are at it let's do some deep dives into the aes layer
This is required to make two plots in one :)

```{r}

# Plotting lncRNA -vs mRNA promoter binding distribution

ggplot(num_peaks_df, aes(x = num_peaks)) +
  geom_point(aes(y = peaks_overlapping_lncrna_promoters), color = "red") +
  geom_point(aes(y = peaks_overlapping_mrna_promoters), color = "black") +
  stat_regline_equation(aes(y = peaks_overlapping_lncrna_promoters), color = "red") +
  stat_regline_equation(aes(y = peaks_overlapping_mrna_promoters), color = "black", label.y = 20000) +
  geom_smooth(aes(y = peaks_overlapping_lncrna_promoters), method = "lm", se = FALSE, formula = "y ~ x") +
  geom_smooth(aes(y = peaks_overlapping_mrna_promoters), method = "lm", se = FALSE, formula = "y ~ x")



# for more advanced figure making check out the code below.
# it is not the best practice to do to many analyses in ggplot.
# The below esxample shows how powerful and flexible ggplot is.


num_peaks_dfl <- num_peaks_df %>%
  dplyr::select(-peaks_overlapping_promoters) %>%
  pivot_longer(cols = peaks_overlapping_lncrna_promoters:peaks_overlapping_mrna_promoters,
               names_to = "gene_type",
               values_to = "peaks_overlapping_promoters") %>%
  mutate(gene_type = gsub("peaks_overlapping_", "", gene_type))

ggplot(num_peaks_dfl, aes(x = num_peaks, y = peaks_overlapping_promoters, 
                         col = gene_type)) +
         geom_point() +
         geom_abline(slope = 1, linetype="dashed") +
  geom_smooth(method = "lm", se = FALSE, formula = "y ~ x") +
  stat_regline_equation() +
  scale_color_manual(values = c("#a8404c", "#424242"))+
  xlab("Peaks per DBP") +
  ylab("Peaks Overlapping Promoters") +
  ggtitle("Number of DBP Peaks and Promoter Overlaps")
ggsave("figures/peaks_overlaps_relationship_by_gene_type.png", height = 5, width = 8)
ggsave("figures/peaks_overlaps_relationship_by_gene_type.pdf", height = 5, width = 8)
``` 


exeRcise:

Make a figure of percentage of peaks for each DBP that overlap promoters & gene bodies.
Add these columns to num_peaks_df