---
title: "18_Rnaseq_part_II"
author: "JR"
date: "11/12/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE)
library(tidyverse)
library(tximport)
library(DESeq2)
library(ggrepel)
library(pheatmap)
```

Let's do some RNAseq !

Goal: Align reads and get the number of reads in each gene in the genome using nf-core/rnaseq 

To use this new version of the nf-core/rnaseq pipeline (v3.4) 
So what we need is

design.csv
nextflow.config file
run.sh


Let's start with the config file -- very similar to nf-core/chipseq
```{bash}
process {
  executor='slurm'
  queue='short'
  memory='16 GB'
  maxForks=10
}
```


Now the run.sh file that gives nf-core/rnaseq all the instructions for nextflow to task.
```{bash run.sh file}

# Here are all the slurm instructions:


#!/bin/bash
#SBATCH -p long
#SBATCH --job-name=hepg2-fraction-RNAseq
#SBATCH --mail-type=END,FAIL
#SBATCH --mail-user=x@colorado.edu
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --mem=6gb
#SBATCH --time=30:00:00
#SBATCH --output=nextflow.out
#SBATCH --error=nextflow.err

pwd; hostname; date
echo "You've requested $SLURM_CPUS_ON_NODE core."

module load singularity/3.1.1

nextflow run nf-core/rnaseq -r 3.4 \
-resume \
-profile singularity \

# Now the inputs for nextflow.

# Firs the design file that we just made.
--input /scratch/Shares/rinnclass/CLASS_2022/hepg2_RNAseq_test/design.csv \

# The genome file
--fasta /scratch/Shares/rinn/genomes/Homo_sapiens/Gencode/v32/GRCh38.p13.genome.fa \

# Genome annotation file
--gtf /scratch/Shares/rinn/genomes/Homo_sapiens/Gencode/v32/gencode.v32.annotation.gtf \

# Salmon will be doing all of the alignments and quantifications
--aligner star_salmon \

# letting pipeline know which type of annotation we are using
--gencode \

-- # PLESAE CHANGE TO YOUR EMAIL john.rinn@colorado.edu \
-c nextflow.config

date
```

Here is the run.sh in full form for nano adjustments
```{bash run.sh}

#!/bin/bash
#SBATCH -p long
#SBATCH --job-name=rna-protein-rnaseq
#SBATCH --mail-type=END,FAIL
#SBATCH --mail-user=john.rinnn@colorado.edu
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --mem=6gb
#SBATCH --time=30:00:00
#SBATCH --output=nextflow.out
#SBATCH --error=nextflow.err

pwd; hostname; date
echo "You've requested $SLURM_CPUS_ON_NODE core."

module load singularity/3.1.1

nextflow run nf-core/rnaseq -r 3.4 \
-resume \
-profile singularity \
--input /scratch/Shares/rinnclass/CLASS_2022/hepg2_RNAseq_test/design.csv \
--fasta /scratch/Shares/rinn/genomes/Mus_musculus/Gencode/M25/GRCm38.p6.genome.fa \
--gtf /scratch/Shares/rinn/genomes/Mus_musculus/Gencode/M25/gencode.vM25.annotation.gtf \
--aligner star_salmon \
--gencode \
--email john.rinn@colorado.edu \
-c nextflow.config

date

```


Now we need the design file, similar to nf-core/chipseq it has to be very specific :)

sample,replicate,fastq_1,fastq_2,strandedness
Our data is not stranded, but this is an important consideration even if you don't have it.

This is an example of good reproducibility. We made the design file in 17 from code someone else could
run and get the exact same design file !


# NEW PIPELINE HAS NUCLEAR FRACTION FAIL :(

# Let's try and run as class on differnet versions


Here is the information for running the original NF_CORE rnaseq 1.4
This is what we ran last year.


NEXTFLOW.CONFIG
```{bash}

process {
  executor='slurm'
  queue='short'
  memory='16 GB'
  maxForks=10
}

```

RUN.SH

```{bash }
#!/bin/bash
#SBATCH -p long
#SBATCH --job-name=CLASS_HEPG2_rna_seq
#SBATCH --mail-type=END,FAIL
#SBATCH --mail-user=john.rinn@colorado.edu
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --mem=6gb
#SBATCH --time=20:00:00
#SBATCH --output=nextflow.out
#SBATCH --error=nextflow.err
pwd; hostname; date
echo "Here we go You've requested $SLURM_CPUS_ON_NODE core."
module load singularity/3.1.1
nextflow run nf-core/rnaseq -r 3.0 \
-resume \
-profile singularity \
--input design.csv \
--aligner star_salmon \
--fasta /scratch/Shares/rinn/genomes/Homo_sapiens/Gencode/v32/GRCh38.p13.genome.fa \
--gtf /scratch/Shares/rinn/genomes/Homo_sapiens/Gencode/v32/gencode.v32.annotation.gtf \
--gencode \
--email john.rinn@colorado.edu \
-c nextflow.config
date

```

NF_CORE RNASEQ 1.4

RUN.SH (NO DESIGN FILE IS NEEDED)
```{bash}

#!/bin/bash
#SBATCH -p long
#SBATCH --job-name=HEPG2_rna_seq
#SBATCH --mail-type=END,FAIL
#SBATCH --mail-user=john.rinn@colorado.edu
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --mem=6gb
#SBATCH --time=20:00:00
#SBATCH --output=nextflow.out
#SBATCH --error=nextflow.err

pwd; hostname; date
echo "Here we go You've requested $SLURM_CPUS_ON_NODE core."

module load singularity/3.1.1

nextflow run nf-core/rnaseq -r 1.4.2 \
-resume \
-profile singularity \
--reads '/Shares/rinn_class/data/CLASS_2022/data/rnaseq/rnaseq_fastq/*{_read1,_read2}.fastq.gz' \
--fasta /scratch/Shares/rinn/genomes/Homo_sapiens/Gencode/v32/GRCh38.p13.genome.fa \
--gtf /scratch/Shares/rinn/genomes/Homo_sapiens/Gencode/v32/gencode.v32.annotation.gtf \
--pseudo_aligner salmon \
--gencode \
--email john.rinn@colorado.edu \
-c nextflow.config

date

```


